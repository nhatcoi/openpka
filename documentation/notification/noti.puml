@startuml Notification System Database Design
!theme plain
skinparam linetype ortho
skinparam backgroundColor #FFFFFF
skinparam entity {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    FontSize 10
}
skinparam relationship {
    Color #424242
    FontSize 10
}

title Notification System Database Design\nTraining Management System

' =============================================
' CORE NOTIFICATION TABLES
' =============================================
package "notification schema" {
    
    entity "notification_templates" {
        * id : BIGINT <<PK>>
        --
        template_key : VARCHAR(100) <<UK>>
        title_template : VARCHAR(255)
        message_template : TEXT
        notification_type : VARCHAR(50)
        language : VARCHAR(10)
        is_active : BOOLEAN
        created_at : TIMESTAMPTZ
        updated_at : TIMESTAMPTZ
    }
    
    entity "notifications" {
        * id : BIGINT <<PK>>
        --
        recipient_id : BIGINT <<FK>>
        sender_id : BIGINT <<FK>>
        notification_type : VARCHAR(50)
        entity_type : VARCHAR(50)
        entity_id : BIGINT
        title : VARCHAR(255)
        message : TEXT
        priority : VARCHAR(20)
        status : VARCHAR(20)
        read_at : TIMESTAMPTZ
        expires_at : TIMESTAMPTZ
        metadata : JSONB
        created_at : TIMESTAMPTZ
        updated_at : TIMESTAMPTZ
    }
    
    entity "notification_preferences" {
        * id : BIGINT <<PK>>
        --
        user_id : BIGINT <<FK>> <<UK>>
        email_enabled : BOOLEAN
        sms_enabled : BOOLEAN
        push_enabled : BOOLEAN
        in_app_enabled : BOOLEAN
        quiet_hours_start : VARCHAR(5)
        quiet_hours_end : VARCHAR(5)
        timezone : VARCHAR(50)
        created_at : TIMESTAMPTZ
        updated_at : TIMESTAMPTZ
    }
    
    entity "notification_deliveries" {
        * id : BIGINT <<PK>>
        --
        notification_id : BIGINT <<FK>>
        channel : VARCHAR(20)
        status : VARCHAR(20)
        sent_at : TIMESTAMPTZ
        delivered_at : TIMESTAMPTZ
        error_message : TEXT
        retry_count : INTEGER
        max_retries : INTEGER
        created_at : TIMESTAMPTZ
    }
    
    entity "notification_queue" {
        * id : BIGINT <<PK>>
        --
        notification_id : BIGINT <<FK>>
        scheduled_at : TIMESTAMPTZ
        priority : INTEGER
        attempts : INTEGER
        max_attempts : INTEGER
        status : VARCHAR(20)
        error_message : TEXT
        processed_at : TIMESTAMPTZ
        created_at : TIMESTAMPTZ
    }
}

' =============================================
' WORKFLOW TABLES
' =============================================
package "workflow engine" {
    
    entity "workflow_definitions" {
        * id : BIGINT <<PK>>
        --
        entity_type : VARCHAR(50)
        workflow_name : VARCHAR(100)
        description : TEXT
        is_active : BOOLEAN
        auto_approval_threshold : INTEGER
        escalation_enabled : BOOLEAN
        created_at : TIMESTAMPTZ
        updated_at : TIMESTAMPTZ
    }
    
    entity "workflow_steps" {
        * id : BIGINT <<PK>>
        --
        workflow_id : BIGINT <<FK>>
        step_order : INTEGER
        step_name : VARCHAR(100)
        approver_role : VARCHAR(50)
        approver_org_level : VARCHAR(20)
        is_parallel : BOOLEAN
        is_required : BOOLEAN
        timeout_days : INTEGER
        escalation_enabled : BOOLEAN
        created_at : TIMESTAMPTZ
    }
    
    entity "workflow_instances" {
        * id : BIGINT <<PK>>
        --
        workflow_id : BIGINT <<FK>>
        entity_type : VARCHAR(50)
        entity_id : BIGINT
        current_step : INTEGER
        status : VARCHAR(20)
        initiated_by : BIGINT <<FK>>
        initiated_at : TIMESTAMPTZ
        completed_at : TIMESTAMPTZ
        metadata : JSONB
    }
    
    entity "approval_records" {
        * id : BIGINT <<PK>>
        --
        workflow_instance_id : BIGINT <<FK>>
        step_id : BIGINT <<FK>>
        approver_id : BIGINT <<FK>>
        action : VARCHAR(20)
        comments : TEXT
        attachments : JSONB
        approved_at : TIMESTAMPTZ
        due_date : TIMESTAMPTZ
        is_escalated : BOOLEAN
    }
}

' =============================================
' EXTERNAL REFERENCES
' =============================================
package "auth schema" {
    entity "users" {
        * id : BIGINT <<PK>>
        --
        username : VARCHAR(64)
        email : VARCHAR(255)
        full_name : VARCHAR(255)
        status : VARCHAR(16)
        created_at : TIMESTAMPTZ
        updated_at : TIMESTAMPTZ
    }
}

' =============================================
' RELATIONSHIPS
' =============================================

' Core notification relationships
notifications ||--o{ notification_deliveries : "1:N"
notifications ||--o{ notification_queue : "1:N"
notifications }o--|| users : "recipient"
notifications }o--o| users : "sender"
notification_preferences }o--|| users : "1:1"

' Workflow relationships
workflow_definitions ||--o{ workflow_steps : "1:N"
workflow_definitions ||--o{ workflow_instances : "1:N"
workflow_instances ||--o{ approval_records : "1:N"
workflow_steps ||--o{ approval_records : "1:N"
workflow_instances }o--|| users : "initiator"
approval_records }o--|| users : "approver"

' Template to notification relationship (logical)
notification_templates ..> notifications : "templates"

note right of notification_templates
  Templates with variable replacement:
  {{entity_type}}, {{entity_id}}, 
  {{approver_name}}, {{timeout_days}}
end note

note right of notifications
  Priority levels:
  - low, medium, high, urgent
  
  Status values:
  - unread, read, archived, deleted
end note

note right of workflow_instances
  Status values:
  - active, completed, rejected, 
  - cancelled, escalated
end note

note right of approval_records
  Action types:
  - approve, reject, request_changes, 
  - escalate
end note

note right of notification_deliveries
  Channels:
  - email, sms, push, in_app, slack
  
  Status values:
  - pending, sent, delivered, 
  - failed, bounced
end note

@enduml
